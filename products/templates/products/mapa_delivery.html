<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>üó∫Ô∏è Seleccion√° tu ubicaci√≥n</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body {
            background-color: #212529; /* fondo oscuro */
            color: #f8f9fa;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        h2 { text-align: center; margin-bottom: 20px; }
        #map {
            height: 70vh;
            width: 100%;
            margin-top: 20px;
            border-radius: 10px;
            border: 2px solid #444;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        .form-container {
            background: #343a40;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.6);
            max-width: 400px;
            margin: 20px auto;
        }
        .form-container input { margin-bottom: 10px; }
    </style>
</head>
<body>
    <h2>üó∫Ô∏è Seleccion√° tu ubicaci√≥n</h2>

    <div id="map"></div>

    <!-- Formulario para hacer pedido -->
    <form id="pedidoForm" method="POST" action="{% url 'products:crear_pedido' %}" class="form-container">
        {% csrf_token %}
        <h4 style="margin-bottom: 10px;">üì¶ Datos del pedido</h4>
        <input type="text" name="customer_name" placeholder="Tu nombre" class="form-control" required>
        <p class="mb-2">üìç Seleccion√° tu ubicaci√≥n en el mapa</p>
        <input type="hidden" name="customer_lat" id="customerLat">
        <input type="hidden" name="customer_lng" id="customerLng">
        <!-- üëâ Aqu√≠ mostramos costo y distancia -->
        <p id="costoDelivery" class="mt-2 text-info"></p>
        <button type="submit" class="btn btn-success w-100">Confirmar ubicaci√≥n y ver productos</button>
    </form>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
    // Ubicaci√≥n fija de la tienda
    const origen = [-34.6037, -58.3816]; // Buenos Aires
    const map = L.map('map').setView(origen, 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Marcador fijo de la tienda
    L.marker(origen).addTo(map).bindPopup("üìç Tienda").openPopup();

    // Marcador interactivo del pedido
    let pedidoMarker;

    // üëâ Detectar ubicaci√≥n autom√°ticamente
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                // Centrar mapa en la ubicaci√≥n del usuario
                map.setView([lat, lng], 15);

                // Crear marcador en la ubicaci√≥n detectada
                pedidoMarker = L.marker([lat, lng], { draggable: true })
                                .addTo(map)
                                .bindPopup("üìç Tu ubicaci√≥n detectada").openPopup();

                // Guardar coordenadas en los inputs ocultos
                document.getElementById("customerLat").value = lat;
                document.getElementById("customerLng").value = lng;

                // Calcular ruta y costo autom√°ticamente
                calcularDelivery(lat, lng);
            },
            function(error) {
                console.error("No se pudo obtener la ubicaci√≥n:", error);
                alert("No se pudo detectar tu ubicaci√≥n autom√°ticamente. Seleccion√° en el mapa.");
            }
        );
    }

    // üëâ Funci√≥n para calcular delivery
    function calcularDelivery(lat, lng) {
        fetch(`/productos/api/calcular-delivery/?lat=${lat}&lng=${lng}`)
          .then(res => res.json())
          .then(data => {
              if (data.success) {
                  document.getElementById("costoDelivery").innerText =
                      `Costo estimado: $${Number(data.costo).toFixed(2)} | Distancia: ${Number(data.distancia_km).toFixed(2)} km`;

                  if (window.rutaPolyline) {
                      map.removeLayer(window.rutaPolyline);
                  }

                  let coords;
                  if (data.geometry.coordinates) {
                      // GeoJSON: [lng, lat] ‚Üí Leaflet: [lat, lng]
                      coords = data.geometry.coordinates.map(c => [c[1], c[0]]);
                  } else {
                      coords = data.geometry;
                  }

                  window.rutaPolyline = L.polyline(coords, { color: 'blue', weight: 4 }).addTo(map);
              }
          })
          .catch(err => console.error("Error en calcular-delivery:", err));
    }

    // üëâ Click manual en el mapa
    map.on('click', function(e) {
        const { lat, lng } = e.latlng;

        if (pedidoMarker) {
            pedidoMarker.setLatLng([lat, lng]);
        } else {
            pedidoMarker = L.marker([lat, lng], { draggable: true })
                            .addTo(map)
                            .bindPopup("üìç Ubicaci√≥n del pedido").openPopup();
        }

        document.getElementById("customerLat").value = lat;
        document.getElementById("customerLng").value = lng;

        calcularDelivery(lat, lng);
    });

    // üëâ Enviar formulario
    const form = document.getElementById("pedidoForm");
    form.addEventListener("submit", function(e) {
        e.preventDefault();

        if (!pedidoMarker) {
            alert("Por favor, seleccion√° la ubicaci√≥n de tu pedido en el mapa.");
            return;
        }

        const data = new FormData(form);

        fetch("{% url 'products:crear_pedido' %}", {
            method: "POST",
            body: data,
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        })
        .then(res => res.json())
        .then(response => {
            if (response.success) {
                window.location.href = "{% url 'products:product_list' %}";
            } else {
                alert(response.error);
            }
        })
        .catch(err => {
            console.error(err);
            alert("Ocurri√≥ un error al crear el pedido.");
        });
    });
    </script>
</body>
</html>



